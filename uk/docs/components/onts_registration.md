# Реєстрація ОНУ на OLT ZTE/Huawei
Цей компонент перевіряє наявність незареєстрованих ONU та дозволяє зареєструвати нові ONU, заповнивши коротку форму.    
Документація описує роботу з двома компонентами: 

- huawei_onts_registration
- zte_onts_registration 

## Як це працює?
Після виявлення незареєстрованого ONU він починає відображатися в списку (на панелі, для всіх пристроїв і в самому пристрої).      
Після натискання кнопки «Зареєструватися» відкривається реєстраційна форма.       
Поля форми для заповнення динамічно генеруються на основі параметрів, підготовлених інженером.       
Після заповнення полів форми та натискання кнопки реєстрації складається список команд для реєстрації ОНУ на основі шаблону, введених параметрів та параметрів, отриманих від пристрою та незареєстрованого ОНУ.          
Якщо компіляція шаблону пройшла успішно, команди будуть виконані на OLT.        
Після успішної реєстрації - буде відображено сповіщення про успішну реєстрацію та автоматично перенаправлено до нового ONU.        

### Примітки

* Весь вивід консолі при реєстрації можна переглянути в журналах викликів обладнання (модуль multi_console_command), як для успішної реєстрації, так і в разі помилки;
* У разі помилки будь-якої з команд, виконання команд буде зупинено.
Помилка може бути вже після введених команд для самої реєстрації ONU.
В цьому випадку потрібно знайти ONU, під яким номером він був зареєстрований і вручну налаштувати на OLT (або видалити його і спробувати зареєструвати знову);
* Щоб створити шаблон, використовуйте [twig](https://twig.symfony.com/). Використовуйте офіційну документацію для механізму шаблонів, щоб дізнатися, які функції доступні. Наприклад, розгалуження (if-else);
* Якщо у вас є якісь унікальні налаштування на кожному окремому OLT - ви можете вказати їх у додаткових параметрах пристрою та використовувати в шаблоні або параметрах. Поширеною практикою є визначення користувацьких vlans (для окремих портів або всього пристрою). Такі параметри будуть доступні в об’єкті `device.params`


## Веб-інтерфейс
### Реєстрація незареєстрованого ОНУ
**Список незареєстрованих ONU на пристрої**
![](../assets/zte_unreg_list.png)

** Реєстраційна форма ОНУ **
![](../assets/zte_reg_form.png)<a id="reg_form"></a>

### Конфігурація реєстрації
**Сторінка конфігурації**
![](../assets/zte_reg_conf_global.png)

**Вкладка налаштувань параметрів**<a id="config_params"></a>
![](../assets/zte_reg_form_params_block.png)

1. Блок вибору пристрою та ONU. У списку пристроїв відображаються лише ZTE OLT. Вам потрібно вибрати пристрій і незареєстрований ONU, щоб отримати список динамічних параметрів.
2. Змінні, доступні після вибору пристрою та ONU, які можна використовувати в налаштуваннях полів реєстраційної форми
3. Поле реєстраційної форми

**Вкладка налаштувань шаблону**<a id="config_template"></a>
![](../assets/zte_reg_conf_template.png)

1. Блок вибору пристрою та ONU. У списку пристроїв відображаються лише ZTE OLT. Вам потрібно вибрати пристрій і незареєстрований ONU, щоб отримати список динамічних параметрів.
2. Реєстраційна форма, підготовлена на [вкладці параметрів](#config_params)
3. Змінні, доступні після вибору пристрою, ONU та заповнення параметрів форми, які можна використовувати для створення шаблону
4. Блок зміни шаблону (під шаблоном також можна переглянути згенерований набір команд)

## Змінні
Змінні - це вкладені об'єкти з полями.
Значення полів об’єкта формується автоматично на основі поточного користувача, обладнання, на якому знаходиться незареєстрований ONU.

Ви можете використовувати ці змінні для створення шаблону, а також поведінки реєстраційної форми.

**Кореневий об’єкт містить такі поля**:

* **user** - поточний користувач у системі
* **пристрій** - пристрій, на якому виконується реєстрація
* **params** - значення, що вводяться в реєстраційну форму
* **профілі** - список лінійних і віддалених профілів, отриманих від OLT
* **onu** - ONU, що реєструється
* **free_onu_numbers** - містить два поля (перший вільний onu) і список усіх вільних onu на порту, де знаходиться незареєстрований ONU.



## Параметри форми реєстрації
### У системі доступні наступні типи параметрів:
* Вибір (розкривний список) із попередньо встановлених значень
* Вибір (розкривний список) змінних
* Поле введення зі значенням за замовчуванням із змінної
* Поле введення


### Типовий блок конфігурації параметрів (наприклад, тип є вибором із попередньо встановлених значень)
![](../assets/zte_param.png)

1. **Key(key)*** - За назвою ключа можна буде отримати доступ до значення параметра в шаблоні, який буде доступний за params.KEY_NAME. Ключі бажано вводити тільки латиницею і, при необхідності, використовувати символи підкреслення;
2. **Відображене ім'я*** - Назва поля, яке буде відображатися в реєстраційній формі;
3. **Прапорець «обов’язковий»** - вказує на те, що під час реєстрації це поле необхідно заповнити (або вибрати в разі випадання);
4. **Тип параметра*** - тип параметра. Ви повинні вибрати одне з наступного;
5. **Видима умова** - умова javascript для відображення поля. Має повертати true або false залежно від змінних.
6. **Кнопка сортування** - утримуючи кнопку, ви можете перетягувати параметр вгору/вниз. Це змінить порядок полів у реєстраційній формі
7. **Кнопка видалення параметра**

_* - Обов'язкове поле_

### Параметри за типами полів
**Виберіть із попередньо встановлених параметрів**
![](../assets/zte_param_choose_from_predefined.png)

1. Тут ви можете вивести список опцій (з нового рядка) для вибору під час реєстрації

**Виберіть зі змінної**
![](../assets/zte_param_choose_from_variable.png)

1. Джерело значень (у списку відображаються лише масиви, що містять примітивні значення)
2. Після вибору - виводиться список значень

**Поле введення зі значенням за замовчуванням із змінної**
![](../assets/zte_param_input_from_variable.png)

1. Джерело значення (у списку відображаються лише змінні примітивного типу)
2. Значення за замовчуванням, якщо немає змінної або порожнє
3. Регулярний вираз для вхідного значення


**Поле введення зі значенням за замовчуванням із змінної**
![](../assets/zte_param_input.png)

1. Значення за замовчуванням
2. Регулярний вираз для вхідного значення


## Шаблон команд
Шаблон використовується для створення списку команд, які будуть виконуватися на OLT під час реєстрації ONU.
При складанні шаблону необхідно використовувати змінні.
Під блоком шаблону(або ж справа) знаходиться інший блок, який компілює шаблон і дозволяє переглядати остаточний список команд, які будуть виконані на OLT.
Складання остаточного списку команд буде працювати тільки при виборі обладнання, ONU. Також рекомендується заповнити форму.    

![](../assets/zte_template_with_live.png) 

1. Шаблонний блок   
2. Блок живих результатів (остаточний список команд)   


Для ОЛТ Huawei, при виконанні команд може знадобитись нажати "Enter" додатково.    
Для цього є спеціальна конструкція - `<cr>`. Додайте `<cr>` в кінець команди, щоб після її введеня додатково було нажато "Enter"    

З версії **0.19** можливо розділити шаблон на блоки.      
Ви можете створити окремо блоки команд і додавати їх в інші блоки за допомогою конструкції 
```twig linenums="1"
{% include 'my_new_block' %} 
```


## Рекомендації щодо налаштування
* Додайте ZTE/Huawei OLT
* Додати незареєстрований ONU в мережу на цьому OLT

Це дозволить вам більш детально зрозуміти, що таке змінні, як вони заповнюються та на живому прикладі побачити генерацію команд


## Готові шаблони реєстрації від користувачів
Шаблони реєстрації представлено в форматі налаштувань компонента.    
Нижче відео, як імпортувати в систему конфігурацію компонента
<iframe width="100%" height="415"
src="https://www.youtube.com/embed/YTPYlFeyUzc">
</iframe>


#### Реєстрація ОНУ на ZTE (@quantum_nintendo)
* [Інструкція.txt](onts_registration/WC_ZTE_REG_quantum_nintendo.txt) 
* [Компонент.json](onts_registration/zte_unregistered_onts_quantum_nintendo.json) 

#### Реєстрація ОНУ на ZTE (@spirit_crasher)
* [Компонент.json](onts_registration/zte_unregistered_onts_spirit_crasher.json) 

#### Реєстрація ОНУ на Huawei 
* [Компонент.json](onts_registration/huawei_onts_registration.json) 


#### Реєстрація ОНУ на Huawei з QinQ
* [Компонент.json](onts_registration/huawei_onts_registration_qnq.json)
* [Додаткові параметри OLT.json](onts_registration/olt_additional_parameters.json)